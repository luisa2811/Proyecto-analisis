"""
SUB-REQUISITO 3: IDENTIFICACIÃ“N DE COMPONENTES FUERTEMENTE CONEXAS

Usa algoritmos de grafos para identificar:
- Grupos de artÃ­culos fuertemente conectados (bidireccional)
- ClÃºsteres temÃ¡ticos o de autores relacionados
- ArtÃ­culos aislados vs artÃ­culos en grupos

Algoritmo: Kosaraju/Tarjan (implementado en NetworkX)

Salidas:
- componentes_fuertemente_conexas.csv (resumen)
- componentes_detalle_completo.csv (todos los artÃ­culos de cada grupo)
"""

import os
import pandas as pd
import networkx as nx

class ComponentesConexas:
    def __init__(self, ruta_grafo="Resultados/grafo_citaciones.graphml", carpeta_resultados="Resultados"):
        self.ruta_grafo = ruta_grafo
        self.carpeta_resultados = carpeta_resultados
        os.makedirs(self.carpeta_resultados, exist_ok=True)
        self.grafo = None
    
    def cargar_grafo(self):
        """Carga el grafo desde el archivo GraphML"""
        print(f"ğŸ“¥ Cargando grafo desde: {self.ruta_grafo}")
        self.grafo = nx.read_graphml(self.ruta_grafo)
        
        # Convertir a DiGraph si es necesario
        if not isinstance(self.grafo, nx.DiGraph):
            self.grafo = nx.DiGraph(self.grafo)
        
        print(f"âœ… Grafo cargado: {self.grafo.number_of_nodes()} nodos, {self.grafo.number_of_edges()} aristas")
        return self.grafo
    
    def identificar_componentes_fuertes(self):
        """
        Identifica componentes fuertemente conexas
        
        Algoritmo: Kosaraju/Tarjan
        - Encuentra grupos donde todos los nodos estÃ¡n conectados bidireccionales
        - Representa clÃºsteres temÃ¡ticos cohesivos
        """
        if self.grafo is None:
            self.cargar_grafo()
        
        print("\n" + "="*70)
        print("SUB-REQUISITO 3: COMPONENTES FUERTEMENTE CONEXAS")
        print("="*70)
        
        G = self.grafo
        
        print("\nğŸ“Œ Algoritmo: KOSARAJU/TARJAN")
        print("   Identificando componentes fuertemente conexas...\n")
        
        # Componentes fuertemente conexas
        componentes_fuertes = list(nx.strongly_connected_components(G))
        componentes_fuertes = sorted(componentes_fuertes, key=len, reverse=True)
        
        print(f"   âœ… Encontradas {len(componentes_fuertes)} componentes fuertemente conexas")
        
        # Mostrar principales
        print("\n   ğŸ“‹ COMPONENTES PRINCIPALES:\n")
        
        resultados_componentes = []
        for i, componente in enumerate(componentes_fuertes[:10], 1):
            tam = len(componente)
            nodos_list = sorted(list(componente))[:10]
            
            print(f"   Componente {i}: {tam} artÃ­culos")
            print(f"   IDs: {nodos_list}{'...' if tam > 10 else ''}")
            
            if tam <= 5:
                print(f"   ArtÃ­culos:")
                for nodo in nodos_list:
                    titulo = G.nodes[nodo].get('titulo', f'ArtÃ­culo {nodo}')[:50]
                    print(f"      â€¢ [{nodo}] {titulo}...")
            print()
            
            resultados_componentes.append({
                'componente_id': i,
                'num_articulos': tam,
                'nodos': str(nodos_list),
                'tipo': 'Principal' if tam > 1 else 'Aislado'
            })
        
        # Componentes dÃ©biles (para comparaciÃ³n)
        componentes_debiles = list(nx.weakly_connected_components(G))
        componentes_debiles = sorted(componentes_debiles, key=len, reverse=True)
        
        print(f"   â„¹ï¸  Componentes dÃ©bilmente conexas: {len(componentes_debiles)}")
        print(f"   â„¹ï¸  Componente dÃ©bil mÃ¡s grande: {len(componentes_debiles[0])} artÃ­culos")
        
        # Guardar resumen
        df_componentes = pd.DataFrame(resultados_componentes)
        ruta = os.path.join(self.carpeta_resultados, "componentes_fuertemente_conexas.csv")
        df_componentes.to_csv(ruta, index=False, encoding='utf-8-sig')
        print(f"\n   ğŸ’¾ Resumen guardado en: {ruta}")
        
        # Guardar detalle completo
        self._guardar_detalle_completo(componentes_fuertes, G)
        
        # Resumen
        articulos_en_grupos = sum(len(c) for c in componentes_fuertes if len(c) > 1)
        articulos_aislados = sum(1 for c in componentes_fuertes if len(c) == 1)
        
        print("\nğŸ“Š RESULTADO SUB-REQUISITO 3:")
        print(f"   â€¢ Componentes fuertemente conexas: {len(componentes_fuertes)}")
        print(f"   â€¢ Componente mÃ¡s grande: {len(componentes_fuertes[0])} artÃ­culos")
        print(f"   â€¢ ArtÃ­culos en grupos temÃ¡ticos: {articulos_en_grupos}")
        print(f"   â€¢ ArtÃ­culos aislados: {articulos_aislados}")
        
        return componentes_fuertes
    
    def _guardar_detalle_completo(self, componentes, G):
        """Guarda detalles completos de cada componente"""
        detalles_completos = []
        
        for i, componente in enumerate(componentes[:20], 1):
            nodos_list = sorted(list(componente))
            
            for nodo in nodos_list:
                titulo = G.nodes[nodo].get('titulo', 'Sin tÃ­tulo')
                if pd.isna(titulo):
                    titulo = f'ArtÃ­culo {nodo}'
                
                autor = G.nodes[nodo].get('autor', 'Sin autor')
                if pd.isna(autor):
                    autor = 'Sin autor'
                
                detalles_completos.append({
                    'componente_id': i,
                    'tamaÃ±o_componente': len(componente),
                    'id_articulo': nodo,
                    'titulo': titulo,
                    'autor': autor,
                    'aÃ±o': G.nodes[nodo].get('aÃ±o', 'N/A')
                })
        
        df_detalles = pd.DataFrame(detalles_completos)
        ruta_detalles = os.path.join(self.carpeta_resultados, "componentes_detalle_completo.csv")
        df_detalles.to_csv(ruta_detalles, index=False, encoding='utf-8-sig')
        print(f"   ğŸ’¾ Detalles completos guardados en: {ruta_detalles}")
        print(f"      (Contiene TODOS los artÃ­culos de cada componente)")
    
    def analizar_componente(self, componente_id):
        """
        Analiza una componente especÃ­fica en detalle
        Muestra todos los artÃ­culos y sus conexiones
        """
        if self.grafo is None:
            self.cargar_grafo()
        
        # Cargar componentes
        try:
            df = pd.read_csv(os.path.join(self.carpeta_resultados, "componentes_detalle_completo.csv"))
            
            componente_df = df[df['componente_id'] == componente_id]
            
            if len(componente_df) == 0:
                print(f"âŒ Componente {componente_id} no encontrada")
                return
            
            print(f"\n{'='*70}")
            print(f"ANÃLISIS DETALLADO: COMPONENTE {componente_id}")
            print(f"{'='*70}")
            
            print(f"\nğŸ“Š Total de artÃ­culos: {len(componente_df)}\n")
            
            for idx, row in componente_df.iterrows():
                print(f"   [{row['id_articulo']}] {row['titulo'][:60]}...")
                print(f"      Autor: {row['autor'][:50]}")
                print(f"      AÃ±o: {row['aÃ±o']}\n")
            
            # Analizar conexiones internas
            G = self.grafo
            nodos_componente = componente_df['id_articulo'].tolist()
            subgrafo = G.subgraph(nodos_componente)
            
            print(f"ğŸ”— Conexiones internas:")
            print(f"   Aristas bidireccionales: {subgrafo.number_of_edges()}")
            print(f"   Densidad del grupo: {nx.density(subgrafo):.4f}")
            
        except FileNotFoundError:
            print("âŒ Primero ejecuta identificar_componentes_fuertes()")
    
    def comparar_componentes(self, top_n=5):
        """
        Compara las principales componentes
        Muestra caracterÃ­sticas de cada grupo
        """
        try:
            df = pd.read_csv(os.path.join(self.carpeta_resultados, "componentes_fuertemente_conexas.csv"))
            
            print(f"\n{'='*70}")
            print(f"COMPARACIÃ“N DE TOP {top_n} COMPONENTES")
            print(f"{'='*70}\n")
            
            for idx, row in df.head(top_n).iterrows():
                print(f"Componente {row['componente_id']}:")
                print(f"   â€¢ TamaÃ±o: {row['num_articulos']} artÃ­culos")
                print(f"   â€¢ Tipo: {row['tipo']}")
                print(f"   â€¢ Primeros IDs: {row['nodos']}\n")
            
        except FileNotFoundError:
            print("âŒ Primero ejecuta identificar_componentes_fuertes()")


if __name__ == "__main__":
    print("\n" + "="*70)
    print(" SUB-REQUISITO 3: COMPONENTES FUERTEMENTE CONEXAS")
    print("="*70)
    
    # Crear instancia
    analizador = ComponentesConexas()
    
    # Cargar grafo
    analizador.cargar_grafo()
    
    # Identificar componentes
    componentes = analizador.identificar_componentes_fuertes()
    
    # Comparar principales componentes
    print("\n" + "="*70)
    print(" COMPARACIÃ“N DE COMPONENTES")
    print("="*70)
    analizador.comparar_componentes(top_n=5)
    
    # Analizar componente mÃ¡s grande
    print("\n" + "="*70)
    print(" ANÃLISIS DETALLADO: COMPONENTE MÃS GRANDE")
    print("="*70)
    if len(componentes) > 0:
        analizador.analizar_componente(componente_id=1)
    
    print("\n" + "="*70)
    print(" âœ… SUB-REQUISITO 3 COMPLETADO")
    print("="*70)
    print("\nğŸ“ Archivos generados:")
    print("   â€¢ componentes_fuertemente_conexas.csv")
    print("   â€¢ componentes_detalle_completo.csv")